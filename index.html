<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ASR Admin | Store Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3577F0',
                        secondary: '#ff497c',
                        dark: '#1F1F24',
                        graytext: '#6B7280',
                        light: '#F3F4F6',
                        border: '#E5E7EB',
                        shopee: '#EE4D2D'
                    },
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    fontSize: {
                        'xxs': '0.65rem',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F8F9FA; -webkit-tap-highlight-color: transparent; font-size: 13px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* SAFE AREA FIX */
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .h-screen-safe { height: 100vh; height: 100dvh; }
        
        /* INPUT STYLES */
        .input-field {
            width: 100%; background-color: #fff; border: 1px solid #E5E7EB;
            padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 500;
            outline: none; transition: all 0.2s;
        }
        .input-field:focus { border-color: #3577F0; ring: 1px solid #3577F0; }
        
        .label-text { display: block; font-size: 10px; font-weight: 700; color: #9CA3AF; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.03em; }

        /* ANIMATION */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        [v-cloak] { display: none; }
        
        /* NAV STYLES */
        .nav-active { color: #3577F0; font-weight: 700; }
        .nav-inactive { color: #9CA3AF; }

        /* CUSTOM BOTTOM NAV POSITION (NAIK 50PX) */
        .bottom-nav-custom {
            bottom: 50px; 
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="text-dark antialiased">

    <div id="app" v-cloak class="h-screen-safe flex flex-col md:flex-row overflow-hidden">

        <div v-if="!isLoggedIn" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#F8F9FA] p-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xs text-center border border-border">
                <div class="w-12 h-12 bg-primary text-white rounded-lg flex items-center justify-center text-xl mx-auto mb-4 shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <h1 class="text-lg font-bold mb-1">Admin Panel</h1>
                <p class="text-xs text-gray-400 mb-6">Login to manage store</p>
                
                <div class="space-y-3 text-left">
                    <div>
                        <label class="label-text">Email</label>
                        <input v-model="loginEmail" type="email" class="input-field" placeholder="admin@asr.com">
                    </div>
                    <div>
                        <label class="label-text">Password</label>
                        <input v-model="loginPass" type="password" class="input-field" placeholder="••••••••">
                    </div>
                    <button @click="handleLogin" :disabled="loading" class="w-full bg-dark text-white py-3 rounded-lg font-bold text-xs shadow-lg hover:bg-black transition flex justify-center items-center gap-2">
                        <span v-if="loading"><i class="fa-solid fa-spinner fa-spin"></i></span>
                        <span v-else>Masuk</span>
                    </button>
                </div>
            </div>
        </div>

        <aside v-if="isLoggedIn" class="hidden md:flex w-64 bg-white border-r border-border flex-col h-full">
            <div class="p-6 flex items-center gap-3 border-b border-border/50">
                <div class="w-8 h-8 bg-primary text-white rounded-lg flex items-center justify-center font-bold">A</div>
                <span class="font-bold text-sm tracking-tight">ASR Admin</span>
            </div>
            <div class="flex-1 p-4 space-y-1">
                <button v-for="item in navItems" @click="view = item.id" 
                    :class="view === item.id ? 'bg-primary/5 text-primary font-bold' : 'text-gray-500 hover:bg-gray-50'"
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-xs transition">
                    <i :class="item.icon" class="w-4"></i> {{ item.label }}
                    <span v-if="item.id === 'orders' && pendingCount > 0" class="ml-auto bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded-md">{{ pendingCount }}</span>
                </button>
            </div>
            <div class="p-4 border-t border-border">
                <button @click="handleLogout" class="flex items-center gap-2 text-red-500 text-xs font-bold hover:text-red-600"><i class="fa-solid fa-power-off"></i> Keluar</button>
            </div>
        </aside>

        <main v-if="isLoggedIn" class="flex-1 flex flex-col h-full bg-[#F8F9FA] relative w-full pt-safe">
            
            <div class="flex-1 overflow-y-auto pb-32 md:pb-0 p-4 md:p-8"> <div class="max-w-6xl mx-auto">
                
                    <div v-if="view === 'dashboard'" class="animate-fade-in">
                        <div class="mb-5 flex justify-between items-end">
                            <h2 class="text-xl font-bold text-dark">Ringkasan Toko</h2>
                            <span class="text-[10px] text-gray-400 font-mono">{{ new Date().toLocaleDateString('id-ID') }}</span>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                            <div class="bg-white p-4 rounded-xl border border-border shadow-sm">
                                <div class="text-[10px] font-bold text-gray-400 uppercase mb-1">Pendapatan</div>
                                <div class="text-lg font-bold text-primary">{{ formatPriceCompact(totalSales) }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-border shadow-sm">
                                <div class="text-[10px] font-bold text-gray-400 uppercase mb-1">Order Masuk</div>
                                <div class="text-lg font-bold text-dark">{{ orders.length }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-border shadow-sm">
                                <div class="text-[10px] font-bold text-gray-400 uppercase mb-1">Produk</div>
                                <div class="text-lg font-bold text-dark">{{ products.length }}</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100 shadow-sm">
                                <div class="text-[10px] font-bold text-red-400 uppercase mb-1">Perlu Kirim</div>
                                <div class="text-lg font-bold text-red-600">{{ pendingCount }}</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-border overflow-hidden shadow-sm">
                            <div class="px-4 py-3 border-b border-border bg-gray-50"><h3 class="font-bold text-xs text-gray-600">Transaksi Terakhir</h3></div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-white text-[10px] uppercase text-gray-400">
                                        <tr><th class="px-4 py-2">ID</th><th class="px-4 py-2">Nama</th><th class="px-4 py-2">Total</th><th class="px-4 py-2">Status</th></tr>
                                    </thead>
                                    <tbody class="text-xs">
                                        <tr v-for="o in orders.slice(0, 5)" :key="o.id" class="border-t border-border hover:bg-gray-50">
                                            <td class="px-4 py-3 font-mono text-gray-500">#{{ o.id.slice(0,4) }}</td>
                                            <td class="px-4 py-3 font-medium">{{ o.customerName }}</td>
                                            <td class="px-4 py-3 font-bold text-dark">{{ formatPrice(o.total) }}</td>
                                            <td class="px-4 py-3"><span :class="statusClass(o.status)" class="px-1.5 py-0.5 rounded text-[9px] uppercase font-bold border">{{ o.status }}</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="view === 'products'" class="animate-fade-in">
                        <div class="flex justify-between items-center mb-5 sticky top-0 bg-[#F8F9FA] z-10 py-2">
                            <h2 class="text-xl font-bold text-dark">Produk</h2>
                            <button @click="openModalProduct()" class="bg-dark text-white px-3 py-2 rounded-lg font-bold text-xs shadow-lg hover:bg-black transition flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> Tambah
                            </button>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div v-for="p in products" :key="p.id" @click="openModalProduct(p)" 
                                class="group bg-white rounded-xl p-2.5 border border-border hover:border-primary cursor-pointer transition shadow-sm relative overflow-hidden">
                                <div v-if="p.shopeeLink" class="absolute top-2 right-2 z-10 text-[10px] bg-shopee text-white px-1.5 rounded font-bold shadow-md"><i class="fa-solid fa-bag-shopping"></i></div>
                                <div class="bg-gray-100 rounded-lg aspect-square mb-2 overflow-hidden">
                                    <img :src="p.image || 'https://via.placeholder.com/150'" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <h3 class="font-bold text-xs truncate text-dark mb-0.5">{{ p.name }}</h3>
                                    <div class="flex justify-between items-center">
                                        <p class="text-primary font-bold text-xs">{{ formatPrice(p.price) }}</p>
                                        <p class="text-[9px] text-gray-400">Stok: {{ p.stok }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="view === 'orders'" class="animate-fade-in">
                        <h2 class="text-xl font-bold text-dark mb-5">Daftar Pesanan</h2>
                        <div class="space-y-3">
                            <div v-for="o in orders" :key="o.id" class="bg-white p-4 rounded-xl border border-border shadow-sm flex flex-col gap-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded text-[9px] font-mono font-bold">#{{ o.id.slice(0,6) }}</span>
                                            <span class="text-[9px] text-gray-400">{{ new Date(o.createdAt).toLocaleString() }}</span>
                                        </div>
                                        <h3 class="font-bold text-sm text-dark">{{ o.customerName }}</h3>
                                        <p class="text-[10px] text-gray-500 line-clamp-1">{{ o.customerAddress }}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-black text-primary">{{ formatPrice(o.total) }}</div>
                                        <select @change="updateOrderStatus(o.id, $event.target.value)" :class="statusBg(o.status)" class="mt-1 text-[10px] font-bold border-none rounded px-1 py-0.5 outline-none cursor-pointer">
                                            <option value="pending" :selected="o.status === 'pending'">Pending</option>
                                            <option value="process" :selected="o.status === 'process'">Proses</option>
                                            <option value="shipped" :selected="o.status === 'shipped'">Dikirim</option>
                                            <option value="done" :selected="o.status === 'done'">Selesai</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded-lg border border-border/50">
                                    <div v-for="item in o.items" class="text-[10px] flex justify-between items-center border-b border-dashed border-gray-200 last:border-0 py-1 first:pt-0 last:pb-0">
                                        <span class="font-medium text-gray-600">{{ item.name }} <span class="text-gray-400">({{ item.color }}/{{ item.size }})</span></span>
                                        <span class="font-bold">x{{ item.qty }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="view === 'cms'" class="animate-fade-in max-w-xl mx-auto">
                        <h2 class="text-xl font-bold text-dark mb-5">Pengaturan Tampilan</h2>
                        <div class="bg-white p-5 rounded-xl border border-border shadow-sm space-y-6">
                            
                            <div>
                                <label class="label-text">Logo Toko</label>
                                <div class="flex items-center gap-3">
                                    <div class="w-16 h-16 bg-gray-50 rounded border border-dashed flex items-center justify-center overflow-hidden">
                                        <img v-if="settings.logo" :src="settings.logo" class="w-full h-full object-contain">
                                        <span v-else class="text-[9px] text-gray-400">No Logo</span>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" @change="uploadSettingImage($event, 'logo')" class="text-[10px] text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                                        <p class="text-[9px] text-gray-400 mt-1">Format: PNG, JPG (Max 1MB)</p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="label-text mb-2">Banner Slider & Copywriting</label>
                                <p class="text-[10px] text-gray-400 mb-3">Upload gambar dan atur teks promosi untuk halaman utama.</p>
                                
                                <div class="space-y-4">
                                    <div v-for="(n, index) in 5" :key="index" class="border border-border rounded-lg p-3 bg-gray-50">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-[10px] font-bold text-gray-500">Banner #{{ index + 1 }}</span>
                                            <button v-if="settings.banners[index] && settings.banners[index].image" @click="removeBanner(index)" class="text-red-500 text-[10px] hover:underline">Hapus</button>
                                        </div>
                                        
                                        <div class="h-28 bg-white rounded border border-dashed flex items-center justify-center overflow-hidden relative group cursor-pointer mb-3" @click="$refs['bannerInput'+index][0].click()">
                                            <img v-if="settings.banners[index] && settings.banners[index].image" :src="settings.banners[index].image" class="w-full h-full object-cover">
                                            <div v-else class="flex flex-col items-center">
                                                <i class="fa-solid fa-plus text-gray-300 mb-1"></i>
                                                <span class="text-[9px] text-gray-400">Upload Banner {{ index+1 }}</span>
                                            </div>
                                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-white text-xs font-bold">Ubah Foto</div>
                                        </div>
                                        <input :ref="'bannerInput'+index" type="file" class="hidden" @change="uploadBanner($event, index)">

                                        <div v-if="settings.banners[index]" class="space-y-2 pt-2 border-t border-gray-200">
                                            <div>
                                                <label class="label-text text-[9px] mb-1">Judul Utama (Headline)</label>
                                                <input v-model="settings.banners[index].title" class="input-field py-1.5" placeholder="Contoh: Diskon Akhir Tahun">
                                            </div>
                                            <div>
                                                <label class="label-text text-[9px] mb-1">Sub Judul (Deskripsi)</label>
                                                <input v-model="settings.banners[index].subtitle" class="input-field py-1.5" placeholder="Contoh: Hemat hingga 50% untuk item terpilih">
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label class="label-text text-[9px] mb-1">Teks Tombol</label>
                                                    <input v-model="settings.banners[index].btnText" class="input-field py-1.5" placeholder="Beli Sekarang">
                                                </div>
                                                <div>
                                                    <label class="label-text text-[9px] mb-1">Link Tujuan (Opsional)</label>
                                                    <input v-model="settings.banners[index].link" class="input-field py-1.5" placeholder="/products atau https://...">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button @click="saveSettings" :disabled="uploadLoading" class="w-full bg-primary text-white py-3 rounded-lg font-bold text-xs mt-2 hover:bg-blue-600 shadow-lg sticky bottom-4 z-20">
                                <span v-if="uploadLoading"><i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...</span>
                                <span v-else>Simpan Semua Perubahan</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="isLoggedIn" class="md:hidden fixed w-full bg-white border-t border-border flex justify-around items-center py-2 z-50 bottom-nav-custom">
            <button v-for="item in navItems" @click="view = item.id" :class="view === item.id ? 'nav-active' : 'nav-inactive'" class="flex flex-col items-center p-2 w-16 transition">
                <div class="relative">
                    <i :class="item.icon" class="text-lg mb-0.5"></i>
                    <span v-if="item.id === 'orders' && pendingCount > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-bold w-3 h-3 rounded-full flex items-center justify-center border border-white">{{ pendingCount }}</span>
                </div>
                <span class="text-[9px] font-medium">{{ item.label }}</span>
            </button>
        </div>

        <div v-if="showModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 pt-safe pb-safe">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showModal = false"></div>
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl relative z-10 flex flex-col max-h-[90vh] overflow-hidden animate-fade-in">
                
                <div class="px-5 py-3 border-b border-border flex justify-between items-center bg-white flex-shrink-0">
                    <h3 class="font-bold text-sm text-dark">{{ isEditing ? 'Edit Produk' : 'Produk Baru' }}</h3>
                    <button @click="showModal = false" class="text-gray-400 hover:text-dark"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>

                <div class="p-5 overflow-y-auto bg-[#F9F9F9] flex-1">
                    <div class="space-y-3">
                        <div>
                            <label class="label-text">Foto Produk</label>
                            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                <div @click="$refs.fileInput.click()" class="w-16 h-16 flex-shrink-0 bg-white border border-dashed border-primary/50 text-primary rounded-lg flex items-center justify-center cursor-pointer hover:bg-blue-50">
                                    <i class="fa-solid fa-camera"></i>
                                </div>
                                <div v-for="(img, idx) in form.images" :key="idx" class="w-16 h-16 flex-shrink-0 bg-white border border-border rounded-lg relative group overflow-hidden">
                                    <img :src="img" class="w-full h-full object-cover">
                                    <button @click="removeImage(idx)" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                            <input ref="fileInput" type="file" multiple class="hidden" @change="handleFileUpload">
                        </div>

                        <div><label class="label-text">Nama Produk</label><input v-model="form.name" class="input-field" placeholder="Nama Produk"></div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="label-text">Kategori</label>
                            <select v-model="form.category" class="input-field cursor-pointer">
                                <option v-for="c in categories" :value="c">{{ c }}</option>
                            </select></div>
                            <div><label class="label-text">Stok</label><input v-model.number="form.stok" type="number" class="input-field"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="label-text">Harga Dasar (Rp)</label><input v-model.number="form.price" type="number" class="input-field"></div>
                            <div><label class="label-text">Diskon (%)</label><input v-model.number="form.discount" type="number" class="input-field"></div>
                        </div>

                        <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                            <label class="label-text text-orange-600 flex items-center gap-1"><i class="fa-solid fa-link"></i> Link Shopee (Affiliate)</label>
                            <input v-model="form.shopeeLink" class="input-field border-orange-200 focus:border-orange-500" placeholder="https://shopee.co.id/product-xxx">
                        </div>

                        <div class="bg-white p-3 rounded-lg border border-border shadow-sm">
                            <label class="text-xs font-bold text-dark mb-2 block border-b border-border pb-1">Varian & Harga (Penting)</label>
                            <div class="mb-3">
                                <label class="label-text">Warna (Pisahkan koma)</label>
                                <input v-model="form.colorsString" class="input-field" placeholder="Hitam, Putih">
                            </div>
                            <div>
                                <label class="label-text">Ukuran (Pisahkan koma)</label>
                                <input v-model="form.sizesString" class="input-field mb-2" placeholder="S, M, L, XL">
                                
                                <div v-if="sizeList.length > 0" class="space-y-2 mt-2 bg-gray-50 p-2 rounded border border-dashed border-gray-300">
                                    <label class="text-[9px] font-bold text-gray-500 uppercase">Set Harga Khusus per Ukuran</label>
                                    <p class="text-[9px] text-gray-400 mb-2">Jika kosong, akan mengikuti harga dasar.</p>
                                    
                                    <div v-for="size in sizeList" :key="size" class="flex items-center gap-2">
                                        <span class="w-10 text-xs font-bold text-center bg-white border border-border py-1.5 rounded">{{ size }}</span>
                                        <input type="number" v-model="form.variantPrices[size]" :placeholder="form.price" class="input-field py-1 h-8 text-xs">
                                        <span class="text-[9px] text-gray-400">IDR</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div><label class="label-text">Deskripsi</label><textarea v-model="form.description" rows="3" class="input-field resize-none"></textarea></div>
                    </div>
                </div>

                <div class="p-4 border-t border-border bg-white flex justify-end gap-2 flex-shrink-0">
                    <button v-if="isEditing" @click="deleteProduct" class="px-4 py-2 bg-red-50 text-red-500 rounded-lg font-bold text-xs hover:bg-red-100">Hapus</button>
                    <button @click="saveProduct" :disabled="uploadLoading" class="px-6 py-2 bg-dark text-white rounded-lg font-bold text-xs hover:bg-black w-full md:w-auto shadow-lg">
                        {{ uploadLoading ? 'Menyimpan...' : 'Simpan' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref, reactive, computed, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = { apiKey: "AIzaSyC131UjEYgOY4MFOOgPXdTSm07TpGWFraE", authDomain: "asr-id.firebaseapp.com", projectId: "asr-id", storageBucket: "asr-id.firebasestorage.app", messagingSenderId: "327137445466", appId: "1:327137445466:web:54a191beedbb06b1fa7a63" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        createApp({
            setup() {
                const isLoggedIn = ref(false);
                const loading = ref(false);
                const uploadLoading = ref(false);
                const view = ref('dashboard');
                const products = ref([]);
                const orders = ref([]);
                
                // SETTINGS: Banners sekarang adalah Array of Objects
                const settings = reactive({ logo: '', banners: [] });
                
                const loginEmail = ref('');
                const loginPass = ref('');
                
                const showModal = ref(false);
                const isEditing = ref(false);
                const editId = ref(null);
                const categories = ['Fashion', 'Gadget', 'Sepatu', 'Elektronik', 'Aksesoris', 'Otomotif'];

                const navItems = [
                    { id: 'dashboard', label: 'Home', icon: 'fa-solid fa-chart-pie' },
                    { id: 'products', label: 'Produk', icon: 'fa-solid fa-box-open' },
                    { id: 'orders', label: 'Pesanan', icon: 'fa-solid fa-clipboard-list' },
                    { id: 'cms', label: 'Tampilan', icon: 'fa-solid fa-palette' }
                ];

                const form = reactive({
                    name: '', price: 0, stok: 1, discount: 0, category: 'Fashion', description: '',
                    images: [], colorsString: '', sizesString: '', shopeeLink: '', variantPrices: {}
                });

                const sizeList = computed(() => {
                    if(!form.sizesString) return [];
                    return form.sizesString.split(',').map(s=>s.trim()).filter(s=>s!=='');
                });

                onAuthStateChanged(auth, (user) => {
                    if(user) { isLoggedIn.value = true; fetchData(); fetchSettings(); } 
                    else { isLoggedIn.value = false; }
                });

                const handleLogin = async () => {
                    loading.value = true;
                    try { await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value); } 
                    catch(e) { alert("Login Gagal"); } finally { loading.value = false; }
                };
                const handleLogout = () => signOut(auth);

                const fetchData = () => {
                    onSnapshot(collection(db, "products"), (snap) => products.value = snap.docs.map(d => ({id: d.id, ...d.data()})) );
                    onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => orders.value = snap.docs.map(d => ({id: d.id, ...d.data()})) );
                };

                const fetchSettings = async () => {
                    const d = await getDoc(doc(db, "settings", "global"));
                    if(d.exists()) {
                        const data = d.data();
                        settings.logo = data.logo || '';
                        
                        // INITIALIZE BANNERS: Convert old string format to Object if needed
                        let rawBanners = data.banners || [];
                        if (data.heroImage && rawBanners.length === 0) rawBanners = [data.heroImage]; // Fallback old hero

                        // Ensure 5 slots are initialized as Objects
                        const formattedBanners = [];
                        for(let i=0; i<5; i++) {
                            const item = rawBanners[i];
                            if(item) {
                                // Jika format lama (string URL), ubah jadi object
                                if(typeof item === 'string') {
                                    formattedBanners.push({ image: item, title: '', subtitle: '', btnText: '', link: '' });
                                } else {
                                    // Jika sudah format object, pakai apa adanya
                                    formattedBanners.push({
                                        image: item.image || '',
                                        title: item.title || '',
                                        subtitle: item.subtitle || '',
                                        btnText: item.btnText || '',
                                        link: item.link || ''
                                    });
                                }
                            } else {
                                // Slot kosong
                                formattedBanners.push({ image: '', title: '', subtitle: '', btnText: '', link: '' });
                            }
                        }
                        settings.banners = formattedBanners;
                    } else {
                         // Default empty structure
                         settings.banners = Array(5).fill({ image: '', title: '', subtitle: '', btnText: '', link: '' });
                    }
                };

                const saveSettings = async () => {
                    uploadLoading.value = true;
                    try { 
                        // Save array of objects
                        const payload = {
                            logo: settings.logo,
                            banners: settings.banners.map(b => ({
                                image: b.image,
                                title: b.title || '',
                                subtitle: b.subtitle || '',
                                btnText: b.btnText || '',
                                link: b.link || ''
                            })),
                            // Backward compatibility for old heroImage
                            heroImage: settings.banners[0]?.image || '' 
                        };
                        await setDoc(doc(db, "settings", "global"), payload, {merge:true}); 
                        alert("Tampilan & Copywriting Berhasil Disimpan!"); 
                    }
                    catch(e) { alert("Gagal: " + e.message); } finally { uploadLoading.value = false; }
                };

                const compressImage = (file) => new Promise((resolve) => {
                    const reader = new FileReader(); reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            const scale = 800 / img.width; 
                            cvs.width = 800; cvs.height = img.height * scale;
                            cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                            resolve(cvs.toDataURL('image/jpeg', 0.7));
                        }
                    }
                });

                const uploadSettingImage = async (e, key) => {
                    if(!e.target.files[0]) return;
                    uploadLoading.value = true;
                    settings[key] = await compressImage(e.target.files[0]);
                    uploadLoading.value = false;
                };

                const uploadBanner = async (e, index) => {
                    if(!e.target.files[0]) return;
                    uploadLoading.value = true;
                    const base64 = await compressImage(e.target.files[0]);
                    
                    // Pastikan object ada sebelum assign property
                    if (!settings.banners[index]) {
                        settings.banners[index] = { image: '', title: '', subtitle: '', btnText: '', link: '' };
                    }
                    
                    settings.banners[index].image = base64;
                    uploadLoading.value = false;
                };

                const removeBanner = (index) => {
                    // Reset object di index tersebut
                    settings.banners[index] = { image: '', title: '', subtitle: '', btnText: '', link: '' };
                };

                const openModalProduct = (item = null) => {
                    isEditing.value = !!item;
                    if(item) {
                        editId.value = item.id;
                        Object.assign(form, item);
                        form.images = item.gallery || (item.image ? [item.image] : []);
                        form.colorsString = item.colors ? item.colors.join(',') : '';
                        form.sizesString = item.sizes ? item.sizes.join(',') : '';
                        form.shopeeLink = item.shopeeLink || '';
                        
                        // RESTORE VARIANT PRICES FROM ARRAY TO OBJECT MAP
                        form.variantPrices = {};
                        if(item.variants && Array.isArray(item.variants)) {
                            item.variants.forEach(v => {
                                if(v.price) form.variantPrices[v.name] = v.price;
                            });
                        }
                    } else {
                        Object.assign(form, { name:'', price:0, stok:1, discount:0, category:'Fashion', description:'', images:[], colorsString:'', sizesString:'', shopeeLink:'', variantPrices:{} });
                    }
                    showModal.value = true;
                };

                const handleFileUpload = async (e) => {
                    uploadLoading.value = true;
                    for (let f of e.target.files) form.images.push(await compressImage(f));
                    uploadLoading.value = false;
                };

                const saveProduct = async () => {
                    uploadLoading.value = true;
                    try {
                        const sizeArray = form.sizesString.split(',').map(s=>s.trim()).filter(s=>s);
                        
                        const variantsArray = sizeArray.map(sizeName => {
                            const specificPrice = form.variantPrices[sizeName];
                            return {
                                name: sizeName,
                                price: specificPrice ? Number(specificPrice) : Number(form.price),
                                originalPrice: Number(form.price)
                            };
                        });

                        const payload = {
                            name: form.name,
                            price: Number(form.price),
                            stok: Number(form.stok),
                            discount: Number(form.discount),
                            category: form.category,
                            description: form.description,
                            shopeeLink: form.shopeeLink || '',
                            image: form.images[0] || '',
                            gallery: [...form.images],
                            colors: form.colorsString.split(',').map(s=>s.trim()).filter(s=>s),
                            sizes: sizeArray,
                            variants: variantsArray,
                            updatedAt: new Date().toISOString()
                        };

                        if(isEditing.value) {
                            await updateDoc(doc(db, "products", editId.value), payload);
                        } else {
                            await addDoc(collection(db, "products"), {...payload, createdAt: new Date().toISOString()});
                        }
                        showModal.value = false;
                    } catch(e) { 
                        console.error(e);
                        alert("Error: " + e.message); 
                    } finally { 
                        uploadLoading.value = false; 
                    }
                };

                const deleteProduct = async () => { if(confirm("Hapus?")) { await deleteDoc(doc(db, "products", editId.value)); showModal.value=false; }};
                const updateOrderStatus = async (id, s) => await updateDoc(doc(db, "orders", id), { status: s });
                const removeImage = (i) => form.images.splice(i, 1);

                const formatPrice = (v) => new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(v);
                const formatPriceCompact = (v) => v >= 1000000 ? (v/1000000).toFixed(1) + 'jt' : (v/1000).toFixed(0) + 'rb';
                const statusClass = (s) => ({'pending':'bg-orange-50 text-orange-600 border-orange-200','process':'bg-blue-50 text-blue-600 border-blue-200','shipped':'bg-purple-50 text-purple-600 border-purple-200','done':'bg-green-50 text-green-600 border-green-200'}[s]||'bg-gray-50');
                const statusBg = (s) => ({'pending':'bg-orange-100 text-orange-700','process':'bg-blue-100 text-blue-700','shipped':'bg-purple-100 text-purple-700','done':'bg-green-100 text-green-700'}[s]);
                
                const pendingCount = computed(() => orders.value.filter(o => o.status === 'pending').length);
                const totalSales = computed(() => orders.value.filter(o => o.status === 'done').reduce((a,b) => a+b.total, 0));

                return { isLoggedIn, loading, uploadLoading, view, products, orders, pendingCount, totalSales, showModal, isEditing, form, sizeList, categories, settings, navItems, loginEmail, loginPass, handleLogin, handleLogout, openModalProduct, handleFileUpload, removeImage, saveProduct, deleteProduct, updateOrderStatus, fetchSettings, saveSettings, uploadSettingImage, uploadBanner, removeBanner, formatPrice, formatPriceCompact, statusClass, statusBg }
            }
        }).mount('#app');
    </script>
</body>
</html>
